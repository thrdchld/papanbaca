<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PapanBaca â€” Belajar Membaca Anak</title>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6366F1">
    <style>
        /* ===== RESET & BASE ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            font-family: 'Comic Neue', 'Comic Sans MS', 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #EEF2FF 0%, #F0F9FF 50%, #ECFDF5 100%);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }

        /* ===== HEADER ===== */
        .header {
            background: linear-gradient(135deg, #6366F1 0%, #8B5CF6 100%);
            padding: 10px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
            z-index: 30;
            flex-shrink: 0;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px
        }

        .logo-tiles {
            display: flex;
            gap: 2px;
            background: rgba(255, 255, 255, 0.15);
            padding: 5px 8px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .logo-char {
            font-size: 1.4rem;
            font-weight: 900
        }

        .logo-a {
            color: #FCD34D
        }

        .logo-b {
            color: #FB923C
        }

        .logo-c {
            color: #34D399
        }

        .logo-text h1 {
            color: #fff;
            font-size: 1.1rem;
            font-weight: 700;
            line-height: 1.2
        }

        .logo-text p {
            color: rgba(255, 255, 255, 0.65);
            font-size: 0.7rem
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 8px
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border: none;
            border-radius: 9999px;
            font-family: inherit;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .btn:active {
            transform: scale(0.93)
        }

        .btn svg {
            flex-shrink: 0
        }

        .btn-mode {
            background: rgba(255, 255, 255, 0.18);
            color: #fff;
            border: 2px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
        }

        .btn-mode:hover {
            background: rgba(255, 255, 255, 0.28)
        }

        .btn-mode.active {
            background: #fff;
            color: #6366F1;
            border-color: #fff
        }

        .btn-read {
            background: #10B981;
            color: #fff;
            box-shadow: 0 4px 0 #059669, 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-read:hover {
            background: #0DD792
        }

        .btn-read:active {
            box-shadow: 0 1px 0 #059669;
            transform: translateY(3px)
        }

        .btn-clear {
            background: rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.85);
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .btn-clear:hover {
            background: #EF4444;
            color: #fff;
            border-color: #EF4444
        }

        /* ===== MAIN BOARD ===== */
        .main-area {
            flex: 1;
            padding: 10px 12px;
            display: flex;
            flex-direction: column;
            min-height: 0
        }

        .board {
            flex: 1;
            position: relative;
            background: #fff;
            border: 5px solid #FCD34D;
            border-radius: 20px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.04), 0 4px 16px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            display: flex;
            background-image: radial-gradient(#E2E8F0 1px, transparent 1px);
            background-size: 24px 24px;
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0.45;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .empty-state.hidden {
            opacity: 0
        }

        .empty-emoji {
            font-size: 3.5rem;
            animation: float 3s ease-in-out infinite
        }

        .empty-text {
            color: #9CA3AF;
            font-weight: 700;
            font-size: 1rem;
            margin-top: 8px;
            text-align: center
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0)
            }

            50% {
                transform: translateY(-12px)
            }
        }

        /* ===== SYLLABLE ZONES ===== */
        .syllable-grid {
            position: absolute;
            inset: 0;
            display: none;
            z-index: 0
        }

        .syllable-grid.active {
            display: flex
        }

        .zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 8px;
            border-right: 2px dashed;
        }

        .zone:last-child {
            border-right: none
        }

        .zone-1 {
            background: rgba(99, 102, 241, 0.04);
            border-color: rgba(99, 102, 241, 0.25)
        }

        .zone-2 {
            background: rgba(139, 92, 246, 0.04);
            border-color: rgba(139, 92, 246, 0.25)
        }

        .zone-3 {
            background: rgba(249, 115, 22, 0.04);
            border-color: rgba(249, 115, 22, 0.25)
        }

        .zone-4 {
            background: rgba(16, 185, 129, 0.04);
            border-color: rgba(16, 185, 129, 0.25)
        }

        .zone-label {
            font-size: 0.6rem;
            font-weight: 700;
            color: #9CA3AF;
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .zone-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 2px solid;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
            z-index: 20;
        }

        .zone-btn:active {
            transform: scale(0.88)
        }

        .zone-1 .zone-btn {
            border-color: #818CF8;
            color: #6366F1
        }

        .zone-1 .zone-btn:hover {
            background: #EEF2FF
        }

        .zone-2 .zone-btn {
            border-color: #A78BFA;
            color: #8B5CF6
        }

        .zone-2 .zone-btn:hover {
            background: #F5F3FF
        }

        .zone-3 .zone-btn {
            border-color: #FB923C;
            color: #F97316
        }

        .zone-3 .zone-btn:hover {
            background: #FFF7ED
        }

        .zone-4 .zone-btn {
            border-color: #34D399;
            color: #10B981
        }

        .zone-4 .zone-btn:hover {
            background: #ECFDF5
        }

        /* ===== LETTERS LAYER ===== */
        .letters-layer {
            position: absolute;
            inset: 0;
            z-index: 10;
            pointer-events: none
        }

        /* ===== LETTER TILE ===== */
        .letter-tile {
            position: absolute;
            width: 60px;
            height: 74px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 2.8rem;
            border-radius: 12px;
            cursor: grab;
            pointer-events: auto;
            touch-action: none;
            transition: box-shadow 0.15s, transform 0.15s;
            border: 3px solid;
        }

        .letter-tile.selected {
            outline: 3px solid #3B82F6;
            outline-offset: 2px;
            filter: brightness(1.1);
        }

        /* ===== SELECTION RECTANGLE ===== */
        .selection-rect {
            position: absolute;
            border: 2px dashed #3B82F6;
            background: rgba(59, 130, 246, 0.1);
            pointer-events: none;
            z-index: 50;
        }

        .letter-tile:active {
            cursor: grabbing
        }

        .letter-tile.dragging {
            box-shadow: 0 16px 32px rgba(0, 0, 0, 0.18) !important;
            transform: scale(1.08) !important;
            z-index: 100 !important;
        }

        /* Color variants */
        .tc-red {
            background: linear-gradient(180deg, #FEF2F2, #FECACA);
            border-color: #FCA5A5;
            color: #DC2626
        }

        .tc-blue {
            background: linear-gradient(180deg, #EFF6FF, #BFDBFE);
            border-color: #93C5FD;
            color: #2563EB
        }

        .tc-green {
            background: linear-gradient(180deg, #F0FDF4, #BBF7D0);
            border-color: #86EFAC;
            color: #16A34A
        }

        .tc-purple {
            background: linear-gradient(180deg, #FAF5FF, #DDD6FE);
            border-color: #C4B5FD;
            color: #7C3AED
        }

        .tc-amber {
            background: linear-gradient(180deg, #FFFBEB, #FDE68A);
            border-color: #FCD34D;
            color: #D97706
        }

        .tc-pink {
            background: linear-gradient(180deg, #FDF2F8, #FBCFE8);
            border-color: #F9A8D4;
            color: #DB2777
        }

        .tile-close {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 22px;
            height: 22px;
            background: #EF4444;
            color: #fff;
            border: 2px solid #fff;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 900;
            cursor: pointer;
            z-index: 50;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            transition: background 0.15s;
            line-height: 1;
        }

        .tile-close:hover {
            background: #DC2626
        }

        /* ===== ANIMATIONS ===== */
        @keyframes pop {
            0% {
                transform: scale(1)
            }

            50% {
                transform: scale(1.12)
            }

            100% {
                transform: scale(1)
            }
        }

        @keyframes drop-in {
            0% {
                transform: scale(0) rotate(-8deg);
                opacity: 0
            }

            60% {
                transform: scale(1.08) rotate(1deg);
                opacity: 1
            }

            100% {
                transform: scale(1) rotate(var(--rot, 0deg));
                opacity: 1
            }
        }

        .pop-anim {
            animation: pop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275)
        }

        .drop-anim {
            animation: drop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards
        }

        /* ===== KEYBOARD ===== */
        .footer {
            background: #fff;
            padding: 8px 12px 10px;
            border-top: 4px solid #EEF2FF;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.04);
            z-index: 40;
            flex-shrink: 0;
        }

        .keyboard {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
            max-height: 28vh;
            overflow-y: auto;
            padding: 2px 4px;
        }

        .key {
            width: 42px;
            height: 50px;
            border: none;
            border-radius: 10px;
            font-family: inherit;
            font-size: 1.5rem;
            font-weight: 900;
            cursor: pointer;
            transition: all 0.12s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .key:active {
            transform: translateY(3px)
        }

        .key-vowel {
            background: linear-gradient(180deg, #FEF3C7, #FDE68A);
            color: #B45309;
            box-shadow: 0 4px 0 #F59E0B, 0 4px 10px rgba(245, 158, 11, 0.25);
        }

        .key-vowel:hover {
            background: linear-gradient(180deg, #FDE68A, #FCD34D)
        }

        .key-vowel:active {
            box-shadow: 0 1px 0 #F59E0B
        }

        .key-consonant {
            background: linear-gradient(180deg, #EEF2FF, #C7D2FE);
            color: #4338CA;
            box-shadow: 0 4px 0 #818CF8, 0 4px 10px rgba(99, 102, 241, 0.18);
        }

        .key-consonant:hover {
            background: linear-gradient(180deg, #E0E7FF, #A5B4FC)
        }

        .key-consonant:active {
            box-shadow: 0 1px 0 #818CF8
        }

        /* ===== RESPONSIVE ===== */
        @media(max-width:640px) {
            .logo-text {
                display: none
            }

            .desktop-label {
                display: none
            }

            .key {
                width: 36px;
                height: 44px;
                font-size: 1.25rem
            }

            .letter-tile {
                width: 50px;
                height: 64px;
                font-size: 2.2rem
            }

            .btn {
                padding: 7px 10px;
                font-size: 0.8rem
            }
        }

        @media(min-width:1024px) {
            .key {
                width: 48px;
                height: 56px;
                font-size: 1.65rem
            }
        }
    </style>
</head>

<body>

    <!-- ===== HEADER ===== -->
    <header class="header">
        <div class="logo">
            <div class="logo-tiles">
                <span class="logo-char logo-a">A</span>
                <span class="logo-char logo-b">B</span>
                <span class="logo-char logo-c">C</span>
            </div>
            <div class="logo-text">
                <h1>Belajar Membaca</h1>
                <p>Papan Baca Indonesia</p>
            </div>
        </div>

        <div class="header-actions">
            <!-- Mode Button -->
            <button id="btnMode" class="btn btn-mode" title="Ganti mode">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <rect x="3" y="3" width="7" height="7" rx="1" />
                    <rect x="14" y="3" width="7" height="7" rx="1" />
                    <rect x="3" y="14" width="7" height="7" rx="1" />
                    <rect x="14" y="14" width="7" height="7" rx="1" />
                </svg>
                <span id="modeText">Bebas</span>
            </button>

            <!-- Read All -->
            <button id="btnReadAll" class="btn btn-read" title="Baca semua huruf">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M11 5L6 9H2v6h4l5 4V5z" />
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07" />
                    <path d="M19.07 4.93a10 10 0 0 1 0 14.14" />
                </svg>
                <span class="desktop-label">Baca</span>
            </button>

            <!-- Clear -->
            <button id="btnClear" class="btn btn-clear" title="Hapus semua">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 6h18" />
                    <path d="M8 6V4a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2" />
                    <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6" />
                </svg>
            </button>
        </div>
    </header>

    <!-- ===== BOARD ===== -->
    <main class="main-area">
        <div id="boardContainer" class="board">

            <!-- Syllable Grid (hidden by default) -->
            <div id="syllableGrid" class="syllable-grid">
                <div class="zone zone-1">
                    <span class="zone-label">Suku 1</span>
                    <button class="zone-btn" onclick="readZone(0)" title="Baca suku kata 1">ðŸ”Š</button>
                </div>
                <div class="zone zone-2">
                    <span class="zone-label">Suku 2</span>
                    <button class="zone-btn" onclick="readZone(1)" title="Baca suku kata 2">ðŸ”Š</button>
                </div>
                <div class="zone zone-3">
                    <span class="zone-label">Suku 3</span>
                    <button class="zone-btn" onclick="readZone(2)" title="Baca suku kata 3">ðŸ”Š</button>
                </div>
                <div class="zone zone-4">
                    <span class="zone-label">Suku 4</span>
                    <button class="zone-btn" onclick="readZone(3)" title="Baca suku kata 4">ðŸ”Š</button>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state">
                <span class="empty-emoji">ðŸ‘†</span>
                <p class="empty-text">Pilih huruf di bawah untuk mulai!</p>
            </div>

            <!-- Letters Canvas -->
            <div id="lettersLayer" class="letters-layer"></div>
        </div>
    </main>

    <!-- ===== KEYBOARD ===== -->
    <footer class="footer">
        <div id="keyboardArea" class="keyboard"></div>
    </footer>

    <script>
        // =====================================================================
        //  PapanBaca â€” App Logic
        // =====================================================================

        // --- DATA & STATE ---
        const VOWELS = new Set(['A', 'I', 'U', 'E', 'O']);
        const TILE_W = 60, TILE_H = 74, TILE_GAP = 8, PAD = 16;
        const TILE_COLORS = ['tc-red', 'tc-blue', 'tc-green', 'tc-purple', 'tc-amber', 'tc-pink'];

        let letters = [];
        let isSyllableMode = false;

        // Drag state
        let draggedId = null;
        let dragOffset = { x: 0, y: 0 };
        let dragStartPos = { x: 0, y: 0 };

        // Multi-select state
        let selectedIds = new Set();
        let isSelecting = false;
        let selectionStart = { x: 0, y: 0 };
        let selectionRect = null;
        let multiDragOffsets = {};

        // --- DOM ---
        const boardEl = document.getElementById('boardContainer');
        const lettersLayer = document.getElementById('lettersLayer');
        const keyboardArea = document.getElementById('keyboardArea');
        const emptyState = document.getElementById('emptyState');
        const syllableGrid = document.getElementById('syllableGrid');
        const btnMode = document.getElementById('btnMode');
        const modeText = document.getElementById('modeText');

        // --- INIT ---
        function init() {
            renderKeyboard();
            setupButtons();
            // Warm up speech voices
            if ('speechSynthesis' in window) {
                window.speechSynthesis.getVoices();
                // Chrome needs a second call after voices are loaded
                window.speechSynthesis.onvoiceschanged = () => window.speechSynthesis.getVoices();
            }
        }

        // --- KEYBOARD RENDERING ---
        function renderKeyboard() {
            const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            keyboardArea.innerHTML = '';
            alphabet.split('').forEach(char => {
                const btn = document.createElement('button');
                btn.className = `key ${VOWELS.has(char) ? 'key-vowel' : 'key-consonant'}`;
                btn.textContent = char;
                btn.onclick = () => addLetter(char);
                keyboardArea.appendChild(btn);
            });
        }

        // --- SMART PLACEMENT ---
        function getNextPosition() {
            const rect = boardEl.getBoundingClientRect();
            const tileW = (window.innerWidth <= 640) ? 50 : TILE_W;
            const tileH = (window.innerWidth <= 640) ? 64 : TILE_H;

            if (letters.length === 0) {
                return { x: PAD, y: Math.max(PAD, (rect.height - tileH) / 2) };
            }

            const last = letters[letters.length - 1];
            let x = last.x + tileW + TILE_GAP;
            let y = last.y;

            // Wrap to next line
            if (x + tileW > rect.width - PAD) {
                x = PAD;
                y += tileH + TILE_GAP;
            }

            // Wrap to top if past bottom
            if (y + tileH > rect.height - PAD) {
                x = PAD;
                y = PAD;
            }

            return { x, y };
        }

        // --- RENDER LETTERS ---
        function renderLetters() {
            lettersLayer.innerHTML = '';
            emptyState.classList.toggle('hidden', letters.length > 0);

            const tileW = (window.innerWidth <= 640) ? 50 : TILE_W;
            const tileH = (window.innerWidth <= 640) ? 64 : TILE_H;
            const fontSize = (window.innerWidth <= 640) ? '2.2rem' : '2.8rem';

            letters.forEach(letter => {
                const el = document.createElement('div');
                el.className = `letter-tile ${letter.colorClass}`;
                if (selectedIds.has(letter.id)) el.classList.add('selected');
                el.id = `letter-${letter.id}`;
                el.textContent = letter.char;
                el.style.left = `${letter.x}px`;
                el.style.top = `${letter.y}px`;
                el.style.setProperty('--rot', `${letter.rotation}deg`);
                el.style.transform = `rotate(${letter.rotation}deg)`;
                el.style.width = `${tileW}px`;
                el.style.height = `${tileH}px`;
                el.style.fontSize = fontSize;
                el.style.zIndex = (letter.id === draggedId) ? 100 : 10;
                el.style.boxShadow = `0 4px 12px rgba(0,0,0,0.1)`;

                // Drag events
                el.addEventListener('mousedown', e => startDrag(e, letter.id));
                el.addEventListener('touchstart', e => startDrag(e, letter.id), { passive: false });

                // Close button
                const closeBtn = document.createElement('div');
                closeBtn.className = 'tile-close';
                closeBtn.textContent = 'Ã—';
                closeBtn.addEventListener('mousedown', e => e.stopPropagation());
                closeBtn.addEventListener('touchstart', e => e.stopPropagation());
                closeBtn.onclick = e => {
                    e.stopPropagation();
                    if (selectedIds.has(letter.id) && selectedIds.size > 1) {
                        removeSelectedLetters();
                    } else {
                        removeLetter(letter.id);
                    }
                };

                el.appendChild(closeBtn);
                lettersLayer.appendChild(el);
            });
        }

        // --- ADD / REMOVE ---
        function addLetter(char) {
            const pos = getNextPosition();
            const newLetter = {
                id: Date.now() + Math.random(),
                char: char,
                x: pos.x,
                y: pos.y,
                colorClass: TILE_COLORS[Math.floor(Math.random() * TILE_COLORS.length)],
                rotation: (Math.random() * 4) - 2  // subtle rotation
            };
            letters.push(newLetter);
            speak(char.toLowerCase());
            renderLetters();

            // Drop-in animation
            requestAnimationFrame(() => {
                const el = document.getElementById(`letter-${newLetter.id}`);
                if (el) el.classList.add('drop-anim');
            });
        }

        function removeLetter(id) {
            const el = document.getElementById(`letter-${id}`);
            selectedIds.delete(id);
            if (el) {
                el.style.transition = 'transform 0.2s, opacity 0.2s';
                el.style.transform = 'scale(0)';
                el.style.opacity = '0';
                setTimeout(() => {
                    letters = letters.filter(l => l.id !== id);
                    renderLetters();
                }, 200);
            } else {
                letters = letters.filter(l => l.id !== id);
                renderLetters();
            }
        }

        function removeSelectedLetters() {
            if (selectedIds.size === 0) return;
            const ids = new Set(selectedIds);
            document.querySelectorAll('.letter-tile.selected').forEach((el, i) => {
                el.style.transition = `transform ${0.15 + i * 0.02}s, opacity ${0.15 + i * 0.02}s`;
                el.style.transform = 'scale(0)';
                el.style.opacity = '0';
            });
            setTimeout(() => {
                letters = letters.filter(l => !ids.has(l.id));
                selectedIds.clear();
                renderLetters();
            }, 250);
        }

        function clearBoard() {
            if (letters.length === 0) return;
            document.querySelectorAll('.letter-tile').forEach((el, i) => {
                el.style.transition = `transform ${0.15 + i * 0.03}s, opacity ${0.15 + i * 0.03}s`;
                el.style.transform = 'scale(0) rotate(20deg)';
                el.style.opacity = '0';
            });
            setTimeout(() => {
                letters = [];
                selectedIds.clear();
                speak('Papan dibersihkan');
                renderLetters();
            }, 300);
        }

        // --- MODE TOGGLE ---
        function toggleMode() {
            isSyllableMode = !isSyllableMode;
            if (isSyllableMode) {
                syllableGrid.classList.add('active');
                modeText.textContent = 'Suku Kata';
                btnMode.classList.add('active');
                speak('Mode suku kata');
            } else {
                syllableGrid.classList.remove('active');
                modeText.textContent = 'Bebas';
                btnMode.classList.remove('active');
                speak('Mode bebas');
            }
        }

        // --- DRAG & DROP (with multi-select support) ---
        function startDrag(e, id) {
            e.preventDefault();
            e.stopPropagation();

            const isCtrl = e.ctrlKey || e.metaKey;

            // Ctrl+click: toggle selection
            if (isCtrl) {
                if (selectedIds.has(id)) {
                    selectedIds.delete(id);
                } else {
                    selectedIds.add(id);
                }
                renderLetters();
                return;
            }

            // If dragging a selected tile, drag all selected
            const isDraggingSelected = selectedIds.has(id) && selectedIds.size > 1;

            draggedId = id;
            const letter = letters.find(l => l.id === id);
            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = boardEl.getBoundingClientRect();

            dragOffset.x = cx - rect.left - letter.x;
            dragOffset.y = cy - rect.top - letter.y;
            dragStartPos.x = cx;
            dragStartPos.y = cy;

            // Store offsets for all selected tiles (for multi-drag)
            if (isDraggingSelected) {
                multiDragOffsets = {};
                selectedIds.forEach(sid => {
                    const sl = letters.find(l => l.id === sid);
                    if (sl) {
                        multiDragOffsets[sid] = {
                            dx: sl.x - letter.x,
                            dy: sl.y - letter.y
                        };
                    }
                });
            } else {
                multiDragOffsets = {};
            }

            const el = document.getElementById(`letter-${id}`);
            if (el) el.classList.add('dragging');

            document.addEventListener('mousemove', onDrag);
            document.addEventListener('touchmove', onDrag, { passive: false });
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function onDrag(e) {
            if (!draggedId) return;
            e.preventDefault();

            const cx = e.touches ? e.touches[0].clientX : e.clientX;
            const cy = e.touches ? e.touches[0].clientY : e.clientY;
            const rect = boardEl.getBoundingClientRect();

            const tileW = (window.innerWidth <= 640) ? 50 : TILE_W;
            const tileH = (window.innerWidth <= 640) ? 64 : TILE_H;

            let nx = cx - rect.left - dragOffset.x;
            let ny = cy - rect.top - dragOffset.y;

            nx = Math.max(0, Math.min(nx, rect.width - tileW));
            ny = Math.max(0, Math.min(ny, rect.height - tileH));

            // Multi-drag: move all selected tiles
            if (Object.keys(multiDragOffsets).length > 0) {
                for (const [sid, off] of Object.entries(multiDragOffsets)) {
                    const sl = letters.find(l => l.id === Number(sid) || l.id === sid);
                    if (sl) {
                        sl.x = Math.max(0, Math.min(nx + off.dx, rect.width - tileW));
                        sl.y = Math.max(0, Math.min(ny + off.dy, rect.height - tileH));
                        const sel = document.getElementById(`letter-${sl.id}`);
                        if (sel) {
                            sel.style.left = `${sl.x}px`;
                            sel.style.top = `${sl.y}px`;
                        }
                    }
                }
            } else {
                const el = document.getElementById(`letter-${draggedId}`);
                if (el) {
                    el.style.left = `${nx}px`;
                    el.style.top = `${ny}px`;
                }
                const letter = letters.find(l => l.id === draggedId);
                if (letter) { letter.x = nx; letter.y = ny; }
            }
        }

        function endDrag(e) {
            if (draggedId) {
                const cx = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                const cy = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                const dist = Math.hypot(cx - dragStartPos.x, cy - dragStartPos.y);

                const el = document.getElementById(`letter-${draggedId}`);
                if (el) el.classList.remove('dragging');

                // Click detection (moved < 5px = tap)
                if (dist < 5 && Object.keys(multiDragOffsets).length === 0) {
                    // If not ctrl and clicking without multi-drag, clear selection first
                    if (!e.ctrlKey && !e.metaKey) {
                        selectedIds.clear();
                    }
                    const letter = letters.find(l => l.id === draggedId);
                    if (el) el.classList.add('pop-anim');
                    setTimeout(() => { if (el) el.classList.remove('pop-anim'); }, 200);
                    if (letter) speak(letter.char.toLowerCase());
                    renderLetters();
                }
            }

            draggedId = null;
            multiDragOffsets = {};
            document.removeEventListener('mousemove', onDrag);
            document.removeEventListener('touchmove', onDrag);
            document.removeEventListener('mouseup', endDrag);
            document.removeEventListener('touchend', endDrag);
        }

        // --- SELECTION RECTANGLE (drag on empty board area) ---
        boardEl.addEventListener('mousedown', function (e) {
            // Only start selection if clicking on the board background (not on a tile)
            if (e.target !== boardEl && e.target !== lettersLayer && e.target !== emptyState
                && !e.target.classList.contains('empty-emoji') && !e.target.classList.contains('empty-text')
                && e.target !== syllableGrid && !e.target.closest('.zone')) return;

            e.preventDefault();
            const rect = boardEl.getBoundingClientRect();
            selectionStart.x = e.clientX - rect.left;
            selectionStart.y = e.clientY - rect.top;
            isSelecting = true;

            // Create selection rectangle
            selectionRect = document.createElement('div');
            selectionRect.className = 'selection-rect';
            selectionRect.style.left = `${selectionStart.x}px`;
            selectionRect.style.top = `${selectionStart.y}px`;
            selectionRect.style.width = '0px';
            selectionRect.style.height = '0px';
            boardEl.appendChild(selectionRect);

            if (!e.ctrlKey && !e.metaKey) {
                selectedIds.clear();
                renderLetters();
            }
        });

        document.addEventListener('mousemove', function (e) {
            if (!isSelecting || !selectionRect) return;
            const rect = boardEl.getBoundingClientRect();
            const cx = e.clientX - rect.left;
            const cy = e.clientY - rect.top;

            const x = Math.min(selectionStart.x, cx);
            const y = Math.min(selectionStart.y, cy);
            const w = Math.abs(cx - selectionStart.x);
            const h = Math.abs(cy - selectionStart.y);

            selectionRect.style.left = `${x}px`;
            selectionRect.style.top = `${y}px`;
            selectionRect.style.width = `${w}px`;
            selectionRect.style.height = `${h}px`;

            // Live-highlight tiles within the selection rect
            const tileW = (window.innerWidth <= 640) ? 50 : TILE_W;
            const tileH = (window.innerWidth <= 640) ? 64 : TILE_H;
            const newSelection = new Set(e.ctrlKey || e.metaKey ? selectedIds : []);
            letters.forEach(l => {
                const tileCx = l.x + tileW / 2;
                const tileCy = l.y + tileH / 2;
                if (tileCx >= x && tileCx <= x + w && tileCy >= y && tileCy <= y + h) {
                    newSelection.add(l.id);
                }
            });
            selectedIds = newSelection;
            renderLetters();
        });

        document.addEventListener('mouseup', function (e) {
            if (!isSelecting) return;
            isSelecting = false;
            if (selectionRect) {
                selectionRect.remove();
                selectionRect = null;
            }
        });

        // Delete key to remove selected
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Delete' || e.key === 'Backspace') {
                if (selectedIds.size > 0 && document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    removeSelectedLetters();
                }
            }
            // Escape to deselect
            if (e.key === 'Escape') {
                selectedIds.clear();
                renderLetters();
            }
        });

        // --- SPEECH ---
        let cachedIdVoice = null;
        let voicesLoaded = false;

        // Load and cache Indonesian voice
        function loadIdVoice() {
            if (!('speechSynthesis' in window)) return;
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) return;
            voicesLoaded = true;
            // Priority: exact id-ID > id_ > contains 'indonesi' > ms-MY (Malay, similar)
            cachedIdVoice =
                voices.find(v => v.lang === 'id-ID') ||
                voices.find(v => v.lang.startsWith('id')) ||
                voices.find(v => v.name.toLowerCase().includes('indonesi')) ||
                voices.find(v => v.lang === 'ms-MY') ||
                null;
            if (cachedIdVoice) console.log('TTS voice:', cachedIdVoice.name, cachedIdVoice.lang);
        }

        // Init voices (async on some browsers)
        if ('speechSynthesis' in window) {
            loadIdVoice();
            window.speechSynthesis.onvoiceschanged = loadIdVoice;
        }

        function speak(text) {
            // Strategy 1: Native speechSynthesis with Indonesian voice
            if ('speechSynthesis' in window && cachedIdVoice) {
                try {
                    window.speechSynthesis.cancel();
                    const u = new SpeechSynthesisUtterance(text);
                    u.voice = cachedIdVoice;
                    u.lang = 'id-ID';
                    u.rate = 0.9;
                    window.speechSynthesis.speak(u);
                    return;
                } catch (_) { /* fall through */ }
            }

            // Strategy 2: Google Translate TTS (always Indonesian)
            try {
                const encoded = encodeURIComponent(text);
                const url = `https://translate.google.com/translate_tts?ie=UTF-8&client=tw-ob&tl=id&q=${encoded}`;
                const audio = new Audio(url);
                audio.volume = 1.0;
                audio.play().catch(() => {
                    // Strategy 3: local audio file fallback
                    speakOffline(text);
                });
                return;
            } catch (_) { /* fall through */ }

            // Strategy 3: Offline audio fallback
            speakOffline(text);
        }

        function speakOffline(text) {
            try {
                const clean = String(text).toLowerCase().replace(/[^a-z0-9_\-]/g, '_');
                new Audio(`assets/sounds/${clean}.mp3`).play().catch(() => { });
            } catch (_) { }
        }

        // Speak with delay (returns a promise)
        function speakWithDelay(text, delayMs) {
            return new Promise(resolve => {
                setTimeout(() => {
                    speak(text);
                    resolve();
                }, delayMs);
            });
        }

        function readAll() {
            if (letters.length === 0) { speak('Kosong'); return; }

            if (isSyllableMode) {
                // Read each zone, then full word
                const rect = boardEl.getBoundingClientRect();
                const zw = rect.width / 4;
                const tileW = (window.innerWidth <= 640) ? 50 : TILE_W;
                const zones = [];
                const fullParts = [];

                for (let zi = 0; zi < 4; zi++) {
                    const zoneLtrs = letters.filter(l => {
                        const cx = l.x + tileW / 2;
                        return cx >= zi * zw && cx < (zi + 1) * zw;
                    }).sort((a, b) => a.x - b.x);
                    if (zoneLtrs.length > 0) {
                        const zoneText = zoneLtrs.map(l => l.char).join('');
                        zones.push(zoneText);
                        fullParts.push(zoneText);
                    }
                }

                if (zones.length === 0) { speak('Kosong'); return; }

                // Read zone by zone, then full word
                let delay = 0;
                zones.forEach((z, i) => {
                    speakWithDelay(z, delay);
                    delay += 800 + z.length * 200;
                });

                // Then read the full combined word
                const fullWord = fullParts.join('');
                speakWithDelay(fullWord, delay + 400);
                setTimeout(() => celebrate(), delay + 400);
            } else {
                const sorted = [...letters].sort((a, b) => a.x - b.x);
                const word = sorted.map(l => l.char).join('');
                speak(word);
                celebrate();
            }
        }

        function readZone(zi) {
            if (letters.length === 0) { speak('Kosong'); return; }
            const rect = boardEl.getBoundingClientRect();
            const zw = rect.width / 4;
            const tileW = (window.innerWidth <= 640) ? 50 : TILE_W;

            const zoneLtrs = letters.filter(l => {
                const cx = l.x + tileW / 2;
                return cx >= zi * zw && cx < (zi + 1) * zw;
            });

            if (zoneLtrs.length === 0) { speak('Kosong'); return; }
            const sorted = zoneLtrs.sort((a, b) => a.x - b.x);
            speak(sorted.map(l => l.char).join(''));
        }

        // --- CELEBRATION (Confetti) ---
        function celebrate() {
            const canvas = document.createElement('canvas');
            Object.assign(canvas.style, {
                position: 'fixed', top: '0', left: '0',
                width: '100vw', height: '100vh',
                pointerEvents: 'none', zIndex: '9999'
            });
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            document.body.appendChild(canvas);

            const ctx = canvas.getContext('2d');
            const colors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#F7DC6F', '#BB8FCE', '#FF69B4', '#82E0AA', '#F8C471'];
            const particles = [];

            for (let i = 0; i < 60; i++) {
                particles.push({
                    x: canvas.width / 2 + (Math.random() - 0.5) * 200,
                    y: canvas.height * 0.6,
                    vx: (Math.random() - 0.5) * 12,
                    vy: -(Math.random() * 14 + 4),
                    size: Math.random() * 8 + 3,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    rot: Math.random() * 360,
                    rotV: (Math.random() - 0.5) * 12,
                    g: 0.18
                });
            }

            let frame = 0;
            function tick() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                let alive = false;

                particles.forEach(p => {
                    p.x += p.vx;
                    p.vy += p.g;
                    p.y += p.vy;
                    p.rot += p.rotV;

                    if (p.y < canvas.height + 40) alive = true;

                    ctx.save();
                    ctx.translate(p.x, p.y);
                    ctx.rotate(p.rot * Math.PI / 180);
                    ctx.fillStyle = p.color;
                    ctx.fillRect(-p.size / 2, -p.size / 2, p.size, p.size);
                    ctx.restore();
                });

                frame++;
                if (alive && frame < 150) {
                    requestAnimationFrame(tick);
                } else {
                    canvas.remove();
                }
            }
            requestAnimationFrame(tick);
        }

        // --- BUTTON SETUP ---
        function setupButtons() {
            document.getElementById('btnClear').onclick = clearBoard;
            document.getElementById('btnReadAll').onclick = readAll;
            document.getElementById('btnMode').onclick = toggleMode;
        }

        // --- START ---
        init();
    </script>
</body>

</html>